function p(e,t){e.forEach(t)}function M({node:e=[],from:t,source:n,parent:o=t||n,to:r,target:a,child:F=r||a,scope:G={},meta:H={},family:k={type:"regular"},regional:I}={}){let L=u(o),b=u(k.links),w=u(k.owners),S=[];p(e,l=>l&&s(S,l));let i={id:Y(),seq:S,next:u(F),meta:H,scope:G,family:{type:k.type||"crosslink",links:b,owners:w}};return p(b,l=>s(d(l),i)),p(w,l=>s(h(l),i)),p(L,l=>s(l.next,i)),I&&T&&Z(O(T),[i]),i}let N="stack",c=e=>e.graphite||e,d=e=>e.family.owners,h=e=>e.family.links,O=e=>e.value,P=e=>e.subscribers,y=(e,t)=>c(e).meta[t],D=e=>(K(e)||C(e))&&"kind"in e;const m=e=>t=>D(t)&&t.kind===e;let E=m("store"),R=m("event"),_=m("effect"),J=m("domain"),U=m("scope");var $={__proto__:null,unit:D,store:E,event:R,effect:_,domain:J,scope:U,attached:e=>_(e)&&y(e,"attached")==1};let g=(e,t)=>{let n=e.indexOf(t);n!==-1&&e.splice(n,1)},s=(e,t)=>e.push(t);const j=()=>{let e=0;return()=>""+ ++e};let X=j(),Y=j(),T=null,Z=(e,t)=>{let n=c(e);p(t,o=>{let r=c(o);n.family.type!=="domain"&&(r.family.type="crosslink"),s(d(r),n),s(h(n),r)})},u=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(c),C=e=>typeof e=="object"&&e!==null,K=e=>typeof e=="function";const z=(e,t,n,o)=>{let r={id:X(),type:e,data:t};return n&&(r.order={priority:n},o&&(r.order.barrierID=++Q)),r};let Q=0,V=({from:e="store",store:t,target:n,to:o=n?"store":N,batch:r,priority:a})=>z("mov",{from:e,store:t,to:o,target:n},a,r),v=({fn:e,batch:t,priority:n,safe:o=0,filter:r=0,pure:a=0})=>z("compute",{fn:e,safe:o,filter:r,pure:a},n,t),B=({fn:e})=>v({fn:e,priority:"effect"}),ee={mov:V,compute:v,filter:({fn:e,pure:t})=>v({fn:e,filter:1,pure:t}),run:B};const W=[];let q=0;for(;q<6;)s(W,{first:null,last:null,size:0}),q+=1;const A=(e,t)=>{g(e.next,t),g(d(e),t),g(h(e),t)},x=(e,t,n)=>{let o;e.next.length=0,e.seq.length=0,e.scope=null;let r=h(e);for(;o=r.pop();)A(o,e),(t||n&&y(e,"op")!=="sample"||o.family.type==="crosslink")&&x(o,t,y(o,"op")!=="on"&&n);for(r=d(e);o=r.pop();)A(o,e),n&&o.family.type==="crosslink"&&x(o,t,y(o,"op")!=="on"&&n)},f=e=>e.clear();let te=(e,{deep:t}={})=>{let n=0;if(e.ownerSet&&e.ownerSet.delete(e),E(e))f(P(e));else if(J(e)){n=1;let o=e.history;f(o.events),f(o.effects),f(o.stores),f(o.domains)}x(c(e),!!t,n)};M({node:[B({fn:({fn:e,value:t})=>e(t)})],meta:{op:"fx",fx:"sidechain"}});export{ee as T,M as a,te as b,$ as n};
