function pe(e,t){for(let r in e)t(e[r],r)}function I(e,t){e.forEach(t)}function z(e,t){if(!e)throw Error(t)}function _t(e,t){let r=R(e).meta||{};M={id:R(e).id,parent:M,value:e,template:r.template||fe(),sidRoot:r.sidRoot||M&&M.sidRoot,meta:r};try{return t()}finally{M=T(M)}}function G({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:i=n||o,scope:d={},meta:g={},family:u={type:"regular"},regional:h}={}){let c=ue(a),p=ue(u.links),l=ue(u.owners),f=[];I(e,m=>m&&F(f,m));let s={id:jt(),seq:f,next:ue(i),meta:g,scope:d,family:{type:u.type||"crosslink",links:p,owners:l}};return I(p,m=>F(xe(m),s)),I(l,m=>F(je(m),s)),I(c,m=>F(m.next,s)),h&&M&&H(ce(M),[s]),s}function X(e,t,r){let a,n=_,o=null,i=$;if(e.target&&(t=e.params,r=e.defer,a=e.meta,n="page"in e?e.page:n,e.stack&&(o=e.stack),i=Q(e)||i,e=e.target),i&&$&&i!==$&&($=null),Array.isArray(e))for(let f=0;f<e.length;f++)K("pure",n,R(e[f]),o,t[f],i,a);else K("pure",n,R(e),o,t,i,a);if(r&&!ye)return;let d,g,u,h,c,p,l={isRoot:ye,currentPage:_,scope:$,isWatch:ke,isPure:we};ye=0;e:for(;h=Nt();){let{idx:f,stack:s,type:m}=h;u=s.node,_=c=s.page,$=Q(s),c?p=c.reg:$&&(p=$.reg);let v=!!c,y=!!$,j={fail:0,scope:u.scope};d=g=0;for(let k=f;k<u.seq.length&&!d;k++){let b=u.seq[k];if(b.order){let{priority:S,barrierID:w}=b.order,x=w?c?`${c.fullID}_${w}`:w:0;if(k!==f||m!==S){w?Ie.has(x)||(Ie.add(x),Fe(k,s,S,w)):Fe(k,s,S);continue e}w&&Ie.delete(x)}switch(b.type){case"mov":{let w,x=b.data;switch(x.from){case Y:w=ce(s);break;case"a":case"b":w=s[x.from];break;case"value":w=x.store;break;case"store":if(p&&!p[x.store.id])if(v){let Re=ft(c,x.store.id);s.page=c=Re,Re?p=Re.reg:y?(le($,x.store,0,1,x.softRead),p=$.reg):p=void 0}else y&&le($,x.store,0,1,x.softRead);w=me(p&&p[x.store.id]||x.store)}switch(x.to){case Y:s.value=w;break;case"a":case"b":s[x.to]=w;break;case"store":Ct(c,$,u,x.target).current=w}break}case"compute":let S=b.data;if(S.fn){ke=q(u,"op")==="watch",we=S.pure;let w=S.safe?(0,S.fn)(ce(s),j.scope,s):Ft(j,S.fn,s);S.filter?g=!w:s.value=w,ke=l.isWatch,we=l.isPure}}d=j.fail||g}if(!d){let k=ce(s),b=Q(s);if(I(u.next,S=>{K("child",c,S,s,k,b)}),b){q(u,"needFxCounter")&&K("child",c,b.fxCount,s,k,b),q(u,"storeChange")&&K("child",c,b.storeChange,s,k,b),q(u,"warnSerialize")&&K("child",c,b.warnSerializeNode,s,k,b);let S=b.additionalLinks[u.id];S&&I(S,w=>{K("child",c,w,s,k,b)})}}}ye=l.isRoot,_=l.currentPage,$=Q(l)}function Xe(e,t="combine"){let r=t+"(",a="",n=0;return pe(e,o=>{n<25&&(o!=null&&(r+=a,r+=Z(o)?Pe(o).fullName:o.toString()),n+=1,a=", ")}),r+")"}function Ye(e,t){let r,a,n=e;if(t){let o=Pe(t);e.length===0?(r=o.path,a=o.fullName):(r=o.path.concat([e]),a=o.fullName.length===0?e:o.fullName+"/"+e)}else r=e.length===0?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function se(e,t){let r=t?e:e[0];it(r);let a=r.or,n=r.and;if(n){let o=t?n:n[0];if(L(o)&&"and"in o){let i=se(n,t);e=i[0],a={...a,...i[1]}}else e=n}return[e,a]}function E(e,...t){let r=fe();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function A(e,t){let r=J({or:t,and:typeof e=="string"?{name:e}:e}),a=(i,...d)=>(ne(!q(a,"derived"),"call of derived event","createEvent"),ne(!we,"unit call from pure function","operators like sample"),_?((g,u,h,c)=>{let p=_,l=null;if(u)for(l=_;l&&l.template!==u;)l=T(l);Ke(l);let f=g.create(h,c);return Ke(p),f})(a,n,i,d):a.create(i,d)),n=fe(),o=Object.assign(a,{graphite:G({meta:Be(r.actualOp||"event",a,r),regional:1}),create:i=>(X({target:a,params:i,scope:$}),i),watch:i=>dt(a,i),map:i=>Me(a,ae,i,[W()]),filter:i=>Me(a,"filter",i.fn?i:i.fn,[W(Te,1)]),filterMap:i=>Me(a,"filterMap",i,[W(),P(d=>!C(d),1)]),prepend(i){let d=A("* → "+a.shortName,{parent:T(a)});return E("eventPrepend",R(d)),te(d,a,[W()],"prepend",i),ut(a,d),d}});return r!=null&&r.domain&&r.domain.hooks.event(o),nt(o.graphite),o}function Ue(e,t,r,a){return ie(r,t,"first argument"),z(N(a),"second argument should be a function"),ne(!q(e,"derived"),`${t} in derived store`,`${t} in store created via createStore`),I(Array.isArray(r)?r:[r],n=>{e.off(n),$e(e).set(n,We(ct(n,e,"on",It,a)))}),e}function B(e,t){let r=J(t),a=oe(e),n=A({named:"updates",derived:1});E("storeBase",a);let o=a.id,i={subscribers:new Map,updates:n,defaultState:e,stateRef:a,getState(){let l,f=a;if(_){let s=_;for(;s&&!s.reg[o];)s=T(s);s&&(l=s)}return!l&&$&&(le($,a,1),l=$),l&&(f=l.reg[o]),me(f)},setState:l=>X({target:i,params:l,defer:1,scope:$}),reset:(...l)=>(I(l,f=>Ue(i,".reset",f,()=>i.defaultState)),i),on:(l,f)=>Ue(i,".on",l,f),off(l){let f=$e(i).get(l);return f&&(f(),$e(i).delete(l)),i},map(l,f){let s,m;L(l)&&(s=l,l=l.fn),ne(C(f),"second argument of store.map","updateFilter");let v=i.getState();fe()?m=null:C(v)||(m=l(v,f));let y=B(m,{name:`${i.shortName} → *`,derived:1,and:s}),j=ct(i,y,ae,Ce,l);return Ae(D(y),{type:ae,fn:l,from:a}),D(y).noInit=1,E("storeMap",a,j),y},watch(l,f){if(!f||!Z(l)){let s=dt(i,l);return E("storeWatch",a,l)||l(i.getState()),s}return z(N(f),"second argument should be a function"),l.watch(s=>f(i.getState(),s))}},d=Be("store",i,r),g=i.defaultConfig.updateFilter;i.graphite=G({scope:{state:a,fn:g},node:[P((l,f,s)=>(s.scope&&!s.scope.reg[a.id]&&(s.b=1),l)),ee(a),P((l,f,{a:s,b:m})=>!C(l)&&(l!==s||m),1),g&&W(Ce,1),O({from:Y,target:a})],child:n,meta:{...d,defaultState:e},regional:1});let u=q(i,"serialize"),h=q(i,"derived"),c=u==="ignore",p=q(i,"sid");return p&&(V(i,"storeChange",1),a.sid=p),p||c||h||V(i,"warnSerialize",1),z(h||!C(e),"current state can't be undefined, use null instead"),H(i,[n]),r!=null&&r.domain&&r.domain.hooks.store(i),h||(i.reinit=A({named:"reinit"}),i.reset(i.reinit)),a.meta=i.graphite.meta,nt(i.graphite),i}function Ze(...e){let t,r,a;[e,a]=se(e);let n,o,i,d=e[e.length-1];if(N(d)?(r=e.slice(0,-1),t=d):r=e,r.length===1){let g=r[0];U(g)||(n=g,o=1)}if(!o&&(n=r,t)){i=1;let g=t;t=u=>g(...u)}return z(L(n),"shape should be an object"),Dt(Array.isArray(n),!i,n,a,t)}function vt(){let e={};return e.req=new Promise((t,r)=>{e.rs=t,e.rj=r}),e.req.catch(()=>{}),e}function et(e,t={}){let r=J(N(e)?{handler:e}:e,t),a=A(N(e)?{handler:e}:e,{...t,actualOp:"effect"}),n=R(a);V(n,"op",a.kind="effect"),a.use=l=>(z(N(l),".use argument should be a function"),h.scope.handler=l,a),a.use.getCurrent=()=>h.scope.handler;let o=a.finally=A({named:"finally",derived:1}),i=a.done=o.filterMap({named:"done",fn({status:l,params:f,result:s}){if(l==="done")return{params:f,result:s}}}),d=a.fail=o.filterMap({named:"fail",fn({status:l,params:f,error:s}){if(l==="fail")return{params:f,error:s}}}),g=a.doneData=i.map({named:"doneData",fn:({result:l})=>l}),u=a.failData=d.map({named:"failData",fn:({error:l})=>l}),h=G({scope:{handler:a.defaultConfig.handler||(()=>z(0,`no handler used in ${a.getType()}`))},node:[P((l,f,s)=>{let m=f.handler,v=Q(s);if(v){let y=a.sid?v.handlers.sidMap[a.sid]:v.handlers.unitMap.get(a);y&&(m=y)}return l.handler=m,l},0,1),P(({params:l,req:f,handler:s,args:m=[l]},v,y)=>{let j=pt(y),k=Se(l,f,1,o,y,j),b=Se(l,f,0,o,y,j),[S,w]=mt(s,b,m);S&&(L(w)&&N(w.then)?w.then(k,b):k(w))},0,1)],meta:{op:"fx",fx:"runner"}});n.scope.runner=h,F(n.seq,P((l,{runner:f},s)=>{let m=T(s)?{params:l,req:{rs(v){},rj(v){}}}:l;return s.meta||(s.meta={fxID:qt()}),X({target:f,params:m,defer:1,scope:Q(s),meta:s.meta}),m.params},0,1)),a.create=l=>{let f=vt(),s={params:l,req:f};if($&&!ke){let m=$;f.req.finally(()=>{zt(m)}).catch(()=>{})}return X({target:a,params:s,scope:$}),f.req};let c=a.inFlight=B(0,{serialize:"ignore",named:(q(a,"name")||a.graphite.id)+".inFlight"}).on(a,l=>l+1).on(o,l=>l-1).map({fn:l=>l,named:"inFlight"});V(o,"needFxCounter","dec"),V(a,"needFxCounter",1);let p=a.pending=c.map({fn:l=>l>0,named:"pending"});return H(a,[o,i,d,g,u,p,c]),r!=null&&r.domain&&r.domain.hooks.effect(a),a}function Ge(e){let t;[e,t]=se(e,1);let{source:r,effect:a,mapParams:n}=e,o=et(e,t);V(o,"attached",1);let i,{runner:d}=R(o).scope,g=P((h,c,p)=>{let l,{params:f,req:s,handler:m}=h,v=o.finally,y=pt(p),j=Se(f,s,0,v,p,y),k=p.a,b=ze(m),S=1;if(n?[S,l]=mt(n,j,[f,k]):l=r&&b?k:f,S){if(!b)return h.args=[k,l],1;X({target:m,params:{params:l,req:{rs:Se(f,s,1,v,p,y),rj:j}},page:p.page,defer:1,meta:p.meta})}},1,1);if(r){let h;U(r)?(h=r,H(h,[o])):(h=Ze(r),H(o,[h])),i=[ee(D(h)),g]}else i=[g];d.seq.splice(1,0,...i),o.use(a);let u=T(a);return u&&(Object.assign(Pe(o),Ye(o.shortName,u)),o.defaultConfig.parent=u),ut(a,o,"effect"),o}function yt(e,t){let r=J({or:t,and:typeof e=="string"?{name:e}:e}),a=G({family:{type:"domain"},regional:1,parent:(r==null?void 0:r.domain)||(r==null?void 0:r.parent)}),n={history:{},graphite:a,hooks:{}};a.meta=Be("domain",n,{parent:(r==null?void 0:r.domain)||(r==null?void 0:r.parent),or:r}),pe({Event:A,Effect:et,Store:B,Domain:yt},(i,d)=>{let g=d.toLowerCase(),u=A({named:`on${d}`});n.hooks[g]=u;let h=new Set;n.history[`${g}s`]=h,u.create=c=>(X(u,c),c),F(R(u).seq,P((c,p,l)=>(l.scope=null,c))),u.watch(c=>{H(n,[c]),h.add(c),c.ownerSet||(c.ownerSet=h),T(c)||(c.parent=n)}),H(n,[u]),n[`onCreate${d}`]=c=>(I(h,c),u.watch(c)),n[`create${d}`]=n[g]=(c,p)=>{let l=J({and:p,or:c});return l!=null&&l.domain?i(c,p):u(i(c,{parent:n,or:l}))}});let o=T(n);return o&&pe(n.hooks,(i,d)=>te(i,o.hooks[d])),r!=null&&r.domain&&r.domain.hooks.domain(n),n}function bt(e,t){ie(e,"merge","first argument");let r=A({name:Xe(e,"merge"),derived:1,and:t});return te(e,r,[],"merge"),r}function tt(e,t){let r=0;return I(Tt,a=>{a in e&&(z(e[a]!=null,gt(t,a)),r=1)}),r}function he(...e){let t,r,a,n,[[o,i,d],g]=se(e),u=1;return C(i)&&L(o)&&tt(o,"sample")&&(i=o.clock,d=o.fn,u=!o.greedy,n=o.filter,t=o.target,r=o.name,a=o.sid,o=o.source),ht("sample",i,o,n,t,d,r,g,u,1,0,a)}function ve(...e){let[[t,r],a]=se(e);return r||(r=t,t=r.source),tt(r,"guard"),ht("guard",r.clock,t,r.filter,r.target,null,r.name,a,!r.greedy,0,1)}let kt=typeof Symbol<"u"&&Symbol.observable||"@@observable",ae="map",Y="stack",R=e=>e.graphite||e,xe=e=>e.family.owners,je=e=>e.family.links,D=e=>e.stateRef,ce=e=>e.value,$e=e=>e.subscribers,T=e=>e.parent,Q=e=>e.scope,q=(e,t)=>R(e).meta[t],V=(e,t,r)=>R(e).meta[t]=r,Pe=e=>e.compositeName,Z=e=>(N(e)||L(e))&&"kind"in e;const ge=e=>t=>Z(t)&&t.kind===e;let U=ge("store"),wt=ge("event"),ze=ge("effect"),rt=ge("domain"),$t=ge("scope");var St={__proto__:null,unit:Z,store:U,event:wt,effect:ze,domain:rt,scope:$t,attached:e=>ze(e)&&q(e,"attached")==1};let be=(e,t)=>{let r=e.indexOf(t);r!==-1&&e.splice(r,1)},F=(e,t)=>e.push(t),ne=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:""}`);const qe=()=>{let e=0;return()=>""+ ++e};let xt=qe(),at=qe(),jt=qe(),qt=qe(),M=null,nt=e=>{},fe=()=>M&&M.template,Rt=e=>(e&&M&&M.sidRoot&&(e=`${M.sidRoot}|${e}`),e),H=(e,t)=>{let r=R(e);I(t,a=>{let n=R(a);r.family.type!=="domain"&&(n.family.type="crosslink"),F(xe(n),r),F(je(r),n)})},ue=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(R),L=e=>typeof e=="object"&&e!==null,N=e=>typeof e=="function",C=e=>e===void 0,it=e=>z(L(e)||N(e),"expect first argument be an object");const He=(e,t,r,a)=>z(!(!L(e)&&!N(e)||!("family"in e)&&!("graphite"in e)),`${t}: expect ${r} to be a unit (store, event or effect)${a}`);let ie=(e,t,r)=>{Array.isArray(e)?I(e,(a,n)=>He(a,t,`${n} item of ${r}`,"")):He(e,t,r," or array of units")},ot=(e,t,r="target")=>I(ue(t),a=>ne(!q(a,"derived"),`${e}: derived unit in "${r}"`,"createEvent/createStore")),Ce=(e,{fn:t},{a:r})=>t(e,r),It=(e,{fn:t},{a:r})=>t(r,e),Te=(e,{fn:t})=>t(e);const lt=(e,t,r,a)=>{let n={id:at(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++Mt)),n};let Mt=0,O=({from:e="store",store:t,target:r,to:a=r?"store":Y,batch:n,priority:o})=>lt("mov",{from:e,store:t,to:a,target:r},o,n),Oe=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0,pure:o=0})=>lt("compute",{fn:e,safe:a,filter:n,pure:o},r,t),st=({fn:e})=>Oe({fn:e,priority:"effect"}),P=(e,t,r)=>Oe({fn:e,safe:1,filter:t,priority:r&&"effect"}),ee=(e,t,r)=>O({store:e,to:t?Y:"a",priority:r&&"sampler",batch:1}),W=(e=Te,t)=>Oe({fn:e,pure:1,filter:t}),oe=e=>({id:at(),current:e}),me=({current:e})=>e,Ae=(e,t)=>{e.before||(e.before=[]),F(e.before,t)},re=null;const _e=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Ee(e.v.type)>Ee(t.v.type))&&(r=e,e=t,t=r),r=_e(e.r,t),e.r=e.l,e.l=r,e},Le=[];let Je=0;for(;Je<6;)F(Le,{first:null,last:null,size:0}),Je+=1;const Nt=()=>{for(let e=0;e<6;e++){let t=Le[e];if(t.size>0){if(e===3||e===4){t.size-=1;let a=re.v;return re=_e(re.l,re.r),a}t.size===1&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},K=(e,t,r,a,n,o,i)=>Fe(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:o,meta:i},e),Fe=(e,t,r,a=0)=>{let n=Ee(r),o=Le[n],i={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};n===3||n===4?re=_e(re,i):(o.size===0?o.first=i:o.last.r=i,o.last=i),o.size+=1},Ee=e=>{switch(e){case"child":return 0;case"pure":return 1;case"read":return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Ie=new Set;let $,ye=1,ke=0,we=0,_=null,zt=e=>{$=e},Ke=e=>{_=e};const ft=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=T(e);if(e)return e}return null};let Ct=(e,t,r,a,n)=>{let o=ft(e,a.id);return o?o.reg[a.id]:t?(le(t,a,n),t.reg[a.id]):a};const At=e=>e;let le=(e,t,r,a,n)=>{var o;let i=e.reg,d=t.sid,g=t==null||(o=t.meta)===null||o===void 0?void 0:o.serialize;if(i[t.id])return;let u={id:t.id,current:t.current,meta:t.meta};if(d&&d in e.values.sidMap&&!(d in e.sidIdMap))u.current=(e.fromSerialize&&g!=="ignore"&&(g==null?void 0:g.read)||At)(e.values.sidMap[d]);else if(u.id in e.values.idMap)u.current=e.values.idMap[u.id];else if(t.before&&!n){let h=0,c=r||!t.noInit||a;I(t.before,p=>{switch(p.type){case ae:{let l=p.from;if(l||p.fn){l&&le(e,l,r,a);let f=l&&i[l.id].current;c&&(u.current=p.fn?p.fn(f):f)}break}case"field":h||(h=1,u.current=Array.isArray(u.current)?[...u.current]:{...u.current}),le(e,p.from,r,a),c&&(u.current[p.field]=i[i[p.from.id].id].current)}})}d&&(e.sidIdMap[d]=t.id),i[t.id]=u};const Ft=(e,t,r)=>{try{return t(ce(r),e.scope,r)}catch(a){console.error(a),e.fail=1,e.failReason=a}};let J=(e,t={})=>(L(e)&&(J(e.or,t),pe(e,(r,a)=>{C(r)||a==="or"||a==="and"||(t[a]=r)}),J(e.and,t)),t);const Qe=(e,t)=>{be(e.next,t),be(xe(e),t),be(je(e),t)},De=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=je(e);for(;a=n.pop();)Qe(a,e),(t||r&&q(e,"op")!=="sample"||a.family.type==="crosslink")&&De(a,t,q(a,"op")!=="on"&&r);for(n=xe(e);a=n.pop();)Qe(a,e),r&&a.family.type==="crosslink"&&De(a,t,q(a,"op")!=="on"&&r)},de=e=>e.clear();let Et=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),U(e))de($e(e));else if(rt(e)){r=1;let a=e.history;de(a.events),de(a.effects),de(a.stores),de(a.domains)}De(R(e),!!t,r)},We=e=>{let t=()=>Et(e);return t.unsubscribe=t,t},te=(e,t,r,a,n)=>G({node:r,parent:e,child:t,scope:{fn:n},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),Lt=e=>{let t="forward",[{from:r,to:a},n]=se(e,1);return ie(r,t,'"from"'),ie(a,t,'"to"'),ot(t,a,"to"),We(G({parent:r,child:a,meta:{op:t,config:n},family:{},regional:1}))},dt=(e,t)=>(z(N(t),".watch argument should be a function"),We(G({scope:{fn:t},node:[st({fn:Te})],parent:e,meta:{op:"watch"},family:{owners:e},regional:1}))),ut=(e,t,r="event")=>{T(e)&&T(e).hooks[r](t)},Be=(e,t,r)=>{let a=J(r),n=e==="domain",o=xt(),{sid:i=null,named:d=null,domain:g=null,parent:u=g}=a,h=d||a.name||(n?"":o),c=Ye(h,u),p={op:t.kind=e,name:t.shortName=h,sid:t.sid=Rt(i),named:d,unitId:t.id=o,serialize:a.serialize,derived:a.derived,config:a};if(t.parent=u,t.compositeName=c,t.defaultConfig=a,t.thru=l=>(ne(0,"thru","js pipe"),l(t)),t.getType=()=>c.fullName,!n){t.subscribe=f=>(it(f),t.watch(N(f)?f:s=>f.next&&f.next(s))),t[kt]=()=>t;let l=fe();l&&(p.nativeTemplate=l)}return p};const Me=(e,t,r,a)=>{let n;L(r)&&(n=r,r=r.fn);let o=A({name:`${e.shortName} → *`,derived:1,and:n});return te(e,o,a,t,r),o},ct=(e,t,r,a,n)=>{let o=D(t),i=O({store:o,to:"a",priority:"read"});r===ae&&(i.data.softRead=1);let d=[i,W(a)];return E("storeOnMap",o,d,U(e)&&D(e)),te(e,t,d,r,n)},Dt=(e,t,r,a,n)=>{let o=e?f=>[...f]:f=>({...f}),i=e?[]:{},d=o(i),g=oe(d),u=oe(1);g.type=e?"list":"shape",g.noInit=1,E("combineBase",g,u);let h=B(d,{name:Xe(r),derived:1,and:a}),c=D(h);c.noInit=1,V(h,"isCombine",1);let p=ee(g);p.order={priority:"barrier"};let l=[P((f,s,m)=>(m.scope&&!m.scope.reg[g.id]&&(m.c=1),f)),p,O({store:u,to:"b"}),P((f,{key:s},m)=>{if(m.c||f!==m.a[s])return t&&m.b&&(m.a=o(m.a)),m.a[s]=f,1},1),O({from:"a",target:g}),O({from:"value",store:0,target:u}),O({from:"value",store:1,target:u,priority:"barrier",batch:1}),ee(g,1),n&&W()];return pe(r,(f,s)=>{if(!U(f))return z(!Z(f)&&!C(f),`combine expects a store in a field ${s}`),void(d[s]=i[s]=f);i[s]=f.defaultState,d[s]=f.getState();let m=te(f,h,l,"combine",n);m.scope.key=s;let v=D(f);Ae(g,{type:"field",field:s,from:v}),E("combineField",v,m)}),h.defaultShape=r,Ae(c,{type:ae,from:g,fn:n}),fe()||(h.defaultState=n?c.current=n(d):i),h};let mt=(e,t,r)=>{try{return[1,e(...r)]}catch(a){return t(a),[0,null]}},pt=e=>{let t=Q(e),r={ref:t};return t&&F(t.activeEffects,r),r},Se=(e,t,r,a,n,o)=>i=>{o.ref&&be(o.ref.activeEffects,o),X({target:[a,Pt],params:[r?{status:"done",params:e,result:i}:{status:"fail",params:e,error:i},{value:i,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:o.ref,meta:n.meta})};const Pt=G({node:[st({fn:({fn:e,value:t})=>e(t)})],meta:{op:"fx",fx:"sidechain"}}),Tt=["source","clock","target"],gt=(e,t)=>e+`: ${t} should be defined`;let ht=(e,t,r,a,n,o,i,d,g,u,h,c)=>{let p=!!n;z(!C(r)||!C(t),gt(e,"either source or clock"));let l=0;C(r)?l=1:Z(r)||(r=Ze(r)),C(t)?t=r:(ie(t,e,"clock"),Array.isArray(t)&&(t=bt(t))),l&&(r=t),d||i||(i=r.shortName);let f="none";(h||a)&&(Z(a)?f="unit":(z(N(a),"`filter` should be function or unit"),f="fn")),n?(ie(n,e,"target"),ot(e,n)):f==="none"&&u&&U(r)&&U(t)?n=B(o?o(me(D(r)),me(D(t))):me(D(r)),{name:i,sid:c,or:d}):(n=A({name:i,derived:1,or:d}),E("sampleTarget",R(n)));let s=oe(),m=[];if(f==="unit"){let[k,b]=Ve(a,n,t,s,e);m=[...Ne(b),...Ne(k)]}let[v,y]=Ve(r,n,t,s,e),j=te(t,n,[E("sampleSourceLoader"),O({from:Y,target:s}),...Ne(y),ee(v,1,g),...m,ee(s),f==="fn"&&W((k,b,{a:S})=>a(k,S),1),o&&W(Ce),E("sampleSourceUpward",p)],e,o);return H(r,[j]),Object.assign(j.meta,d,{joint:1}),n};const Ne=e=>[ee(e),P((t,r,{a})=>a,1)],Ve=(e,t,r,a,n)=>{let o=U(e),i=o?D(e):oe(),d=oe(o);return o||G({parent:e,node:[O({from:Y,target:i}),O({from:"value",store:1,target:d})],family:{owners:[e,t,r],links:t},meta:{op:n},regional:1}),E("sampleSource",d,i,a),[i,d]};function Wt(e){var{timeout:t,start:r,stop:a,leading:n=!1,trailing:o=!1}=e,i=A({name:"tick",sid:"u782pl"}),d=B(!1,{name:"$isRunning",sid:"-xegewf"}),g=Ot(t),u=d.map(m=>!m),h=A({name:"saveTimeout",sid:"ab3q7d"}),c=B(null,{name:"$timeoutId",sid:"-aj5rja"}).on(h,(m,v)=>{var{timeoutId:y}=v;return y}),p=B(()=>{},{name:"$rejecter",sid:"opb0ih"}).on(h,(m,v)=>{var{reject:y}=v;return y}),l=Ge({and:{source:{timeout:g,running:d},effect:m=>{var{timeout:v,running:y}=m;return y?new Promise((j,k)=>{var b=setTimeout(j,v);h({timeoutId:b,reject:k})}):Promise.reject()}},or:{name:"timeoutFx",sid:"9hil7b"}}),f=Ge({and:{source:{timeoutId:c,rejecter:p},effect:m=>{var{timeoutId:v,rejecter:y}=m;y(),v&&clearTimeout(v)}},or:{name:"cleanupFx",sid:"-v02m7d"}});if(ve({and:[{clock:r,source:g,filter:u,target:l}],or:{sid:"-vop0ii"}}),n){var s=ve({and:[{clock:r,filter:u}],or:{name:"onReady",sid:"-cmw7lh"}});he({and:[{clock:s,target:i}],or:{sid:"-v876ny"}})}return he({and:[{clock:r,fn:()=>!0,target:d}],or:{sid:"-v6jsxl"}}),ve({and:[{clock:l.done,source:g,filter:d,target:l}],or:{sid:"-urpcwu"}}),ve({and:[{clock:l.done,filter:d,target:i.prepend(()=>{})}],or:{sid:"-ucb4aq"}}),a&&(o&&he({and:[{clock:a,target:i}],or:{sid:"6lcn0o"}}),d.on(a,()=>!1),he({and:[{clock:a,target:f}],or:{sid:"71ao6f"}})),{tick:i,isRunning:d}}function Ot(e){if(St.store(e,{sid:"7icamc"}))return e;if(typeof e=="number")return B(e,{and:{name:"$timeout"},sid:"knc3em"});throw new TypeError('timeout parameter in interval method should be number or Store. "'.concat(typeof e,'" was passed'))}export{ve as $,Lt as S,G as a,_t as b,Et as c,Wt as i,yt as k,St as n,B as p,A as u,he as x,et as y};
