function ye(e,t){for(let r in e)t(e[r],r)}function A(e,t){e.forEach(t)}function R(e,t){if(!e)throw Error(t)}function $t(e,t){let r=z(e).meta||{};C={id:z(e).id,parent:C,value:e,template:r.template||ce(),sidRoot:r.sidRoot||C&&C.sidRoot,meta:r};try{return t()}finally{C=_(C)}}function W({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:i,child:o=n||i,scope:u={},meta:g={},family:d={type:"regular"},regional:h}={}){let c=me(a),p=me(d.links),l=me(d.owners),s=[];A(e,m=>m&&I(s,m));let f={id:Dt(),seq:s,next:me(o),meta:g,scope:u,family:{type:d.type||"crosslink",links:p,owners:l}};return A(p,m=>I(Ne(m),f)),A(l,m=>I(ze(m),f)),A(c,m=>I(m.next,f)),h&&C&&G(ge(C),[f]),f}function Z(e,t,r){let a,n=L,i=null,o=x;if(e.target&&(t=e.params,r=e.defer,a=e.meta,n="page"in e?e.page:n,e.stack&&(i=e.stack),o=X(e)||o,e=e.target),o&&x&&o!==x&&(x=null),Array.isArray(e))for(let s=0;s<e.length;s++)Q("pure",n,z(e[s]),i,t[s],o,a);else Q("pure",n,z(e),i,t,o,a);if(r&&!be)return;let u,g,d,h,c,p,l={isRoot:be,currentPage:L,scope:x,isWatch:we,isPure:Se};be=0;e:for(;h=_t();){let{idx:s,stack:f,type:m}=h;d=f.node,L=c=f.page,x=X(f),c?p=c.reg:x&&(p=x.reg);let $=!!c,v=!!x,w={fail:0,scope:d.scope};u=g=0;for(let y=s;y<d.seq.length&&!u;y++){let b=d.seq[y];if(b.order){let{priority:S,barrierID:k}=b.order,M=k?c?`${c.fullID}_${k}`:k:0;if(y!==s||m!==S){k?Re.has(M)||(Re.add(M),Oe(y,f,S,k)):Oe(y,f,S);continue e}k&&Re.delete(M)}switch(b.type){case"mov":{let k,M=b.data;switch(M.from){case ee:k=ge(f);break;case"a":case"b":k=f[M.from];break;case"value":k=M.store;break;case"store":if(p&&!p[M.store.id])if($){let q=pt(c,M.store.id);f.page=c=q,q?p=q.reg:v?(fe(x,M.store,0,1,M.softRead),p=x.reg):p=void 0}else v&&fe(x,M.store,0,1,M.softRead);k=he(p&&p[M.store.id]||M.store)}switch(M.to){case ee:f.value=k;break;case"a":case"b":f[M.to]=k;break;case"store":Lt(c,x,d,M.target).current=k}break}case"compute":let S=b.data;if(S.fn){we=N(d,"op")==="watch",Se=S.pure;let k=S.safe?(0,S.fn)(ge(f),w.scope,f):Bt(w,S.fn,f);S.filter?g=!k:f.value=k,we=l.isWatch,Se=l.isPure}}u=w.fail||g}if(!u){let y=ge(f),b=X(f);if(A(d.next,S=>{Q("child",c,S,f,y,b)}),b){N(d,"needFxCounter")&&Q("child",c,b.fxCount,f,y,b),N(d,"storeChange")&&Q("child",c,b.storeChange,f,y,b),N(d,"warnSerialize")&&Q("child",c,b.warnSerializeNode,f,y,b);let S=b.additionalLinks[d.id];S&&A(S,k=>{Q("child",c,k,f,y,b)})}}}be=l.isRoot,L=l.currentPage,x=X(l)}function rt(e,t="combine"){let r=t+"(",a="",n=0;return ye(e,i=>{n<25&&(i!=null&&(r+=a,r+=te(i)?Le(i).fullName:i.toString()),n+=1,a=", ")}),r+")"}function at(e,t){let r,a,n=e;if(t){let i=Le(t);e.length===0?(r=i.path,a=i.fullName):(r=i.path.concat([e]),a=i.fullName.length===0?e:i.fullName+"/"+e)}else r=e.length===0?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function ue(e,t){let r=t?e:e[0];ft(r);let a=r.or,n=r.and;if(n){let i=t?n:n[0];if(B(i)&&"and"in i){let o=ue(n,t);e=o[0],a={...a,...o[1]}}else e=n}return[e,a]}function P(e,...t){let r=ce();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function j(e,t){let r=H({or:t,and:typeof e=="string"?{name:e}:e}),a=(o,...u)=>(ie(!N(a,"derived"),"call of derived event","createEvent"),ie(!Se,"unit call from pure function","operators like sample"),L?((g,d,h,c)=>{let p=L,l=null;if(d)for(l=L;l&&l.template!==d;)l=_(l);Ye(l);let s=g.create(h,c);return Ye(p),s})(a,n,o,u):a.create(o,u)),n=ce(),i=Object.assign(a,{graphite:W({meta:He(r.actualOp||"event",a,r),regional:1}),create:o=>(Z({target:a,params:o,scope:x}),o),watch:o=>gt(a,o),map:o=>je(a,oe,o,[K()]),filter:o=>je(a,"filter",o.fn?o:o.fn,[K(We,1)]),filterMap:o=>je(a,"filterMap",o,[K(),O(u=>!D(u),1)]),prepend(o){let u=j("* → "+a.shortName,{parent:_(a)});return P("eventPrepend",z(u)),ae(u,a,[K()],"prepend",o),ht(a,u),u}});return r!=null&&r.domain&&r.domain.hooks.event(i),st(i.graphite),i}function Je(e,t,r,a){return le(r,t,"first argument"),R(E(a),"second argument should be a function"),ie(!N(e,"derived"),`${t} in derived store`,`${t} in store created via createStore`),A(Array.isArray(r)?r:[r],n=>{e.off(n),$e(e).set(n,Ge(yt(n,e,"on",Ft,a)))}),e}function de(e,t){let r=H(t),a=se(e),n=j({named:"updates",derived:1});P("storeBase",a);let i=a.id,o={subscribers:new Map,updates:n,defaultState:e,stateRef:a,getState(){let l,s=a;if(L){let f=L;for(;f&&!f.reg[i];)f=_(f);f&&(l=f)}return!l&&x&&(fe(x,a,1),l=x),l&&(s=l.reg[i]),he(s)},setState:l=>Z({target:o,params:l,defer:1,scope:x}),reset:(...l)=>(A(l,s=>Je(o,".reset",s,()=>o.defaultState)),o),on:(l,s)=>Je(o,".on",l,s),off(l){let s=$e(o).get(l);return s&&(s(),$e(o).delete(l)),o},map(l,s){let f,m;B(l)&&(f=l,l=l.fn),ie(D(s),"second argument of store.map","updateFilter");let $=o.getState();ce()?m=null:D($)||(m=l($,s));let v=de(m,{name:`${o.shortName} → *`,derived:1,and:f}),w=yt(o,v,oe,Pe,l);return Fe(F(v),{type:oe,fn:l,from:a}),F(v).noInit=1,P("storeMap",a,w),v},watch(l,s){if(!s||!te(l)){let f=gt(o,l);return P("storeWatch",a,l)||l(o.getState()),f}return R(E(s),"second argument should be a function"),l.watch(f=>s(o.getState(),f))}},u=He("store",o,r),g=o.defaultConfig.updateFilter;o.graphite=W({scope:{state:a,fn:g},node:[O((l,s,f)=>(f.scope&&!f.scope.reg[a.id]&&(f.b=1),l)),re(a),O((l,s,{a:f,b:m})=>!D(l)&&(l!==f||m),1),g&&K(Pe,1),T({from:ee,target:a})],child:n,meta:{...u,defaultState:e},regional:1});let d=N(o,"serialize"),h=N(o,"derived"),c=d==="ignore",p=N(o,"sid");return p&&(Y(o,"storeChange",1),a.sid=p),p||c||h||Y(o,"warnSerialize",1),R(h||!D(e),"current state can't be undefined, use null instead"),G(o,[n]),r!=null&&r.domain&&r.domain.hooks.store(o),h||(o.reinit=j({named:"reinit"}),o.reset(o.reinit)),a.meta=o.graphite.meta,st(o.graphite),o}function nt(...e){let t,r,a;[e,a]=ue(e);let n,i,o,u=e[e.length-1];if(E(u)?(r=e.slice(0,-1),t=u):r=e,r.length===1){let g=r[0];U(g)||(n=g,i=1)}if(!i&&(n=r,t)){o=1;let g=t;t=d=>g(...d)}return R(B(n),"shape should be an object"),Kt(Array.isArray(n),!o,n,a,t)}function Mt(){let e={};return e.req=new Promise((t,r)=>{e.rs=t,e.rj=r}),e.req.catch(()=>{}),e}function xe(e,t={}){let r=H(E(e)?{handler:e}:e,t),a=j(E(e)?{handler:e}:e,{...t,actualOp:"effect"}),n=z(a);Y(n,"op",a.kind="effect"),a.use=l=>(R(E(l),".use argument should be a function"),h.scope.handler=l,a),a.use.getCurrent=()=>h.scope.handler;let i=a.finally=j({named:"finally",derived:1}),o=a.done=i.filterMap({named:"done",fn({status:l,params:s,result:f}){if(l==="done")return{params:s,result:f}}}),u=a.fail=i.filterMap({named:"fail",fn({status:l,params:s,error:f}){if(l==="fail")return{params:s,error:f}}}),g=a.doneData=o.map({named:"doneData",fn:({result:l})=>l}),d=a.failData=u.map({named:"failData",fn:({error:l})=>l}),h=W({scope:{handler:a.defaultConfig.handler||(()=>R(0,`no handler used in ${a.getType()}`))},node:[O((l,s,f)=>{let m=s.handler,$=X(f);if($){let v=a.sid?$.handlers.sidMap[a.sid]:$.handlers.unitMap.get(a);v&&(m=v)}return l.handler=m,l},0,1),O(({params:l,req:s,handler:f,args:m=[l]},$,v)=>{let w=bt(v),y=Me(l,s,1,i,v,w),b=Me(l,s,0,i,v,w),[S,k]=vt(f,b,m);S&&(B(k)&&E(k.then)?k.then(y,b):y(k))},0,1)],meta:{op:"fx",fx:"runner"}});n.scope.runner=h,I(n.seq,O((l,{runner:s},f)=>{let m=_(f)?{params:l,req:{rs($){},rj($){}}}:l;return f.meta||(f.meta={fxID:It()}),Z({target:s,params:m,defer:1,scope:X(f),meta:f.meta}),m.params},0,1)),a.create=l=>{let s=Mt(),f={params:l,req:s};if(x&&!we){let m=x;s.req.finally(()=>{Tt(m)}).catch(()=>{})}return Z({target:a,params:f,scope:x}),s.req};let c=a.inFlight=de(0,{serialize:"ignore",named:(N(a,"name")||a.graphite.id)+".inFlight"}).on(a,l=>l+1).on(i,l=>l-1).map({fn:l=>l,named:"inFlight"});Y(i,"needFxCounter","dec"),Y(a,"needFxCounter",1);let p=a.pending=c.map({fn:l=>l>0,named:"pending"});return G(a,[i,o,u,g,d,p,c]),r!=null&&r.domain&&r.domain.hooks.effect(a),a}function Jt(e){let t;[e,t]=ue(e,1);let{source:r,effect:a,mapParams:n}=e,i=xe(e,t);Y(i,"attached",1);let o,{runner:u}=z(i).scope,g=O((h,c,p)=>{let l,{params:s,req:f,handler:m}=h,$=i.finally,v=bt(p),w=Me(s,f,0,$,p,v),y=p.a,b=Ie(m),S=1;if(n?[S,l]=vt(n,w,[s,y]):l=r&&b?y:s,S){if(!b)return h.args=[y,l],1;Z({target:m,params:{params:l,req:{rs:Me(s,f,1,$,p,v),rj:w}},page:p.page,defer:1,meta:p.meta})}},1,1);if(r){let h;U(r)?(h=r,G(h,[i])):(h=nt(r),G(i,[h])),o=[re(F(h)),g]}else o=[g];u.seq.splice(1,0,...o),i.use(a);let d=_(a);return d&&(Object.assign(Le(i),at(i.shortName,d)),i.defaultConfig.parent=d),ht(a,i,"effect"),i}function Nt(e,t){let r=H({or:t,and:typeof e=="string"?{name:e}:e}),a=W({family:{type:"domain"},regional:1,parent:(r==null?void 0:r.domain)||(r==null?void 0:r.parent)}),n={history:{},graphite:a,hooks:{}};a.meta=He("domain",n,{parent:(r==null?void 0:r.domain)||(r==null?void 0:r.parent),or:r}),ye({Event:j,Effect:xe,Store:de,Domain:Nt},(o,u)=>{let g=u.toLowerCase(),d=j({named:`on${u}`});n.hooks[g]=d;let h=new Set;n.history[`${g}s`]=h,d.create=c=>(Z(d,c),c),I(z(d).seq,O((c,p,l)=>(l.scope=null,c))),d.watch(c=>{G(n,[c]),h.add(c),c.ownerSet||(c.ownerSet=h),_(c)||(c.parent=n)}),G(n,[d]),n[`onCreate${u}`]=c=>(A(h,c),d.watch(c)),n[`create${u}`]=n[g]=(c,p)=>{let l=H({and:p,or:c});return l!=null&&l.domain?o(c,p):d(o(c,{parent:n,or:l}))}});let i=_(n);return i&&ye(n.hooks,(o,u)=>ae(o,i.hooks[u])),r!=null&&r.domain&&r.domain.hooks.domain(n),n}function zt(e,t){le(e,"merge","first argument");let r=j({name:rt(e,"merge"),derived:1,and:t});return ae(e,r,[],"merge"),r}function ot(e,t){let r=0;return A(Gt,a=>{a in e&&(R(e[a]!=null,kt(t,a)),r=1)}),r}function Qe(...e){let t,r,a,n,[[i,o,u],g]=ue(e),d=1;return D(o)&&B(i)&&ot(i,"sample")&&(o=i.clock,u=i.fn,d=!i.greedy,n=i.filter,t=i.target,r=i.name,a=i.sid,i=i.source),wt("sample",o,i,n,t,u,r,g,d,1,0,a)}function At(...e){let[[t,r],a]=ue(e);return r||(r=t,t=r.source),ot(r,"guard"),wt("guard",r.clock,t,r.filter,r.target,null,r.name,a,!r.greedy,0,1)}let qt=typeof Symbol<"u"&&Symbol.observable||"@@observable",oe="map",ee="stack",z=e=>e.graphite||e,Ne=e=>e.family.owners,ze=e=>e.family.links,F=e=>e.stateRef,ge=e=>e.value,$e=e=>e.subscribers,_=e=>e.parent,X=e=>e.scope,N=(e,t)=>z(e).meta[t],Y=(e,t,r)=>z(e).meta[t]=r,Le=e=>e.compositeName,te=e=>(E(e)||B(e))&&"kind"in e;const ve=e=>t=>te(t)&&t.kind===e;let U=ve("store"),Ct=ve("event"),Ie=ve("effect"),it=ve("domain"),Et=ve("scope");var Rt={__proto__:null,unit:te,store:U,event:Ct,effect:Ie,domain:it,scope:Et,attached:e=>Ie(e)&&N(e,"attached")==1};let ke=(e,t)=>{let r=e.indexOf(t);r!==-1&&e.splice(r,1)},I=(e,t)=>e.push(t),ie=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:""}`);const Ae=()=>{let e=0;return()=>""+ ++e};let jt=Ae(),lt=Ae(),Dt=Ae(),It=Ae(),C=null,st=e=>{},ce=()=>C&&C.template,Pt=e=>(e&&C&&C.sidRoot&&(e=`${C.sidRoot}|${e}`),e),G=(e,t)=>{let r=z(e);A(t,a=>{let n=z(a);r.family.type!=="domain"&&(n.family.type="crosslink"),I(Ne(n),r),I(ze(r),n)})},me=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(z),B=e=>typeof e=="object"&&e!==null,E=e=>typeof e=="function",D=e=>e===void 0,ft=e=>R(B(e)||E(e),"expect first argument be an object");const Ve=(e,t,r,a)=>R(!(!B(e)&&!E(e)||!("family"in e)&&!("graphite"in e)),`${t}: expect ${r} to be a unit (store, event or effect)${a}`);let le=(e,t,r)=>{Array.isArray(e)?A(e,(a,n)=>Ve(a,t,`${n} item of ${r}`,"")):Ve(e,t,r," or array of units")},ut=(e,t,r="target")=>A(me(t),a=>ie(!N(a,"derived"),`${e}: derived unit in "${r}"`,"createEvent/createStore")),Pe=(e,{fn:t},{a:r})=>t(e,r),Ft=(e,{fn:t},{a:r})=>t(r,e),We=(e,{fn:t})=>t(e);const dt=(e,t,r,a)=>{let n={id:lt(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++Ot)),n};let Ot=0,T=({from:e="store",store:t,target:r,to:a=r?"store":ee,batch:n,priority:i})=>dt("mov",{from:e,store:t,to:a,target:r},i,n),Be=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0,pure:i=0})=>dt("compute",{fn:e,safe:a,filter:n,pure:i},r,t),ct=({fn:e})=>Be({fn:e,priority:"effect"}),O=(e,t,r)=>Be({fn:e,safe:1,filter:t,priority:r&&"effect"}),re=(e,t,r)=>T({store:e,to:t?ee:"a",priority:r&&"sampler",batch:1}),K=(e=We,t)=>Be({fn:e,pure:1,filter:t}),se=e=>({id:lt(),current:e}),he=({current:e})=>e,Fe=(e,t)=>{e.before||(e.before=[]),I(e.before,t)},ne=null;const Ke=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||_e(e.v.type)>_e(t.v.type))&&(r=e,e=t,t=r),r=Ke(e.r,t),e.r=e.l,e.l=r,e},Ue=[];let Xe=0;for(;Xe<6;)I(Ue,{first:null,last:null,size:0}),Xe+=1;const _t=()=>{for(let e=0;e<6;e++){let t=Ue[e];if(t.size>0){if(e===3||e===4){t.size-=1;let a=ne.v;return ne=Ke(ne.l,ne.r),a}t.size===1&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Q=(e,t,r,a,n,i,o)=>Oe(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:i,meta:o},e),Oe=(e,t,r,a=0)=>{let n=_e(r),i=Ue[n],o={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};n===3||n===4?ne=Ke(ne,o):(i.size===0?i.first=o:i.last.r=o,i.last=o),i.size+=1},_e=e=>{switch(e){case"child":return 0;case"pure":return 1;case"read":return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Re=new Set;let x,be=1,we=0,Se=0,L=null,Tt=e=>{x=e},Ye=e=>{L=e};const pt=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=_(e);if(e)return e}return null};let Lt=(e,t,r,a,n)=>{let i=pt(e,a.id);return i?i.reg[a.id]:t?(fe(t,a,n),t.reg[a.id]):a};const Wt=e=>e;let fe=(e,t,r,a,n)=>{var i;let o=e.reg,u=t.sid,g=t==null||(i=t.meta)===null||i===void 0?void 0:i.serialize;if(o[t.id])return;let d={id:t.id,current:t.current,meta:t.meta};if(u&&u in e.values.sidMap&&!(u in e.sidIdMap))d.current=(e.fromSerialize&&g!=="ignore"&&(g==null?void 0:g.read)||Wt)(e.values.sidMap[u]);else if(d.id in e.values.idMap)d.current=e.values.idMap[d.id];else if(t.before&&!n){let h=0,c=r||!t.noInit||a;A(t.before,p=>{switch(p.type){case oe:{let l=p.from;if(l||p.fn){l&&fe(e,l,r,a);let s=l&&o[l.id].current;c&&(d.current=p.fn?p.fn(s):s)}break}case"field":h||(h=1,d.current=Array.isArray(d.current)?[...d.current]:{...d.current}),fe(e,p.from,r,a),c&&(d.current[p.field]=o[o[p.from.id].id].current)}})}u&&(e.sidIdMap[u]=t.id),o[t.id]=d};const Bt=(e,t,r)=>{try{return t(ge(r),e.scope,r)}catch(a){console.error(a),e.fail=1,e.failReason=a}};let H=(e,t={})=>(B(e)&&(H(e.or,t),ye(e,(r,a)=>{D(r)||a==="or"||a==="and"||(t[a]=r)}),H(e.and,t)),t);const Ze=(e,t)=>{ke(e.next,t),ke(Ne(e),t),ke(ze(e),t)},Te=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ze(e);for(;a=n.pop();)Ze(a,e),(t||r&&N(e,"op")!=="sample"||a.family.type==="crosslink")&&Te(a,t,N(a,"op")!=="on"&&r);for(n=Ne(e);a=n.pop();)Ze(a,e),r&&a.family.type==="crosslink"&&Te(a,t,N(a,"op")!=="on"&&r)},pe=e=>e.clear();let mt=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),U(e))pe($e(e));else if(it(e)){r=1;let a=e.history;pe(a.events),pe(a.effects),pe(a.stores),pe(a.domains)}Te(z(e),!!t,r)},Ge=e=>{let t=()=>mt(e);return t.unsubscribe=t,t},ae=(e,t,r,a,n)=>W({node:r,parent:e,child:t,scope:{fn:n},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),V=e=>{let t="forward",[{from:r,to:a},n]=ue(e,1);return le(r,t,'"from"'),le(a,t,'"to"'),ut(t,a,"to"),Ge(W({parent:r,child:a,meta:{op:t,config:n},family:{},regional:1}))},gt=(e,t)=>(R(E(t),".watch argument should be a function"),Ge(W({scope:{fn:t},node:[ct({fn:We})],parent:e,meta:{op:"watch"},family:{owners:e},regional:1}))),ht=(e,t,r="event")=>{_(e)&&_(e).hooks[r](t)},He=(e,t,r)=>{let a=H(r),n=e==="domain",i=jt(),{sid:o=null,named:u=null,domain:g=null,parent:d=g}=a,h=u||a.name||(n?"":i),c=at(h,d),p={op:t.kind=e,name:t.shortName=h,sid:t.sid=Pt(o),named:u,unitId:t.id=i,serialize:a.serialize,derived:a.derived,config:a};if(t.parent=d,t.compositeName=c,t.defaultConfig=a,t.thru=l=>(ie(0,"thru","js pipe"),l(t)),t.getType=()=>c.fullName,!n){t.subscribe=s=>(ft(s),t.watch(E(s)?s:f=>s.next&&s.next(f))),t[qt]=()=>t;let l=ce();l&&(p.nativeTemplate=l)}return p};const je=(e,t,r,a)=>{let n;B(r)&&(n=r,r=r.fn);let i=j({name:`${e.shortName} → *`,derived:1,and:n});return ae(e,i,a,t,r),i},yt=(e,t,r,a,n)=>{let i=F(t),o=T({store:i,to:"a",priority:"read"});r===oe&&(o.data.softRead=1);let u=[o,K(a)];return P("storeOnMap",i,u,U(e)&&F(e)),ae(e,t,u,r,n)},Kt=(e,t,r,a,n)=>{let i=e?s=>[...s]:s=>({...s}),o=e?[]:{},u=i(o),g=se(u),d=se(1);g.type=e?"list":"shape",g.noInit=1,P("combineBase",g,d);let h=de(u,{name:rt(r),derived:1,and:a}),c=F(h);c.noInit=1,Y(h,"isCombine",1);let p=re(g);p.order={priority:"barrier"};let l=[O((s,f,m)=>(m.scope&&!m.scope.reg[g.id]&&(m.c=1),s)),p,T({store:d,to:"b"}),O((s,{key:f},m)=>{if(m.c||s!==m.a[f])return t&&m.b&&(m.a=i(m.a)),m.a[f]=s,1},1),T({from:"a",target:g}),T({from:"value",store:0,target:d}),T({from:"value",store:1,target:d,priority:"barrier",batch:1}),re(g,1),n&&K()];return ye(r,(s,f)=>{if(!U(s))return R(!te(s)&&!D(s),`combine expects a store in a field ${f}`),void(u[f]=o[f]=s);o[f]=s.defaultState,u[f]=s.getState();let m=ae(s,h,l,"combine",n);m.scope.key=f;let $=F(s);Fe(g,{type:"field",field:f,from:$}),P("combineField",$,m)}),h.defaultShape=r,Fe(c,{type:oe,from:g,fn:n}),ce()||(h.defaultState=n?c.current=n(u):o),h};let vt=(e,t,r)=>{try{return[1,e(...r)]}catch(a){return t(a),[0,null]}},bt=e=>{let t=X(e),r={ref:t};return t&&I(t.activeEffects,r),r},Me=(e,t,r,a,n,i)=>o=>{i.ref&&ke(i.ref.activeEffects,i),Z({target:[a,Ut],params:[r?{status:"done",params:e,result:o}:{status:"fail",params:e,error:o},{value:o,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:i.ref,meta:n.meta})};const Ut=W({node:[ct({fn:({fn:e,value:t})=>e(t)})],meta:{op:"fx",fx:"sidechain"}}),Gt=["source","clock","target"],kt=(e,t)=>e+`: ${t} should be defined`;let wt=(e,t,r,a,n,i,o,u,g,d,h,c)=>{let p=!!n;R(!D(r)||!D(t),kt(e,"either source or clock"));let l=0;D(r)?l=1:te(r)||(r=nt(r)),D(t)?t=r:(le(t,e,"clock"),Array.isArray(t)&&(t=zt(t))),l&&(r=t),u||o||(o=r.shortName);let s="none";(h||a)&&(te(a)?s="unit":(R(E(a),"`filter` should be function or unit"),s="fn")),n?(le(n,e,"target"),ut(e,n)):s==="none"&&d&&U(r)&&U(t)?n=de(i?i(he(F(r)),he(F(t))):he(F(r)),{name:o,sid:c,or:u}):(n=j({name:o,derived:1,or:u}),P("sampleTarget",z(n)));let f=se(),m=[];if(s==="unit"){let[y,b]=et(a,n,t,f,e);m=[...De(b),...De(y)]}let[$,v]=et(r,n,t,f,e),w=ae(t,n,[P("sampleSourceLoader"),T({from:ee,target:f}),...De(v),re($,1,g),...m,re(f),s==="fn"&&K((y,b,{a:S})=>a(y,S),1),i&&K(Pe),P("sampleSourceUpward",p)],e,i);return G(r,[w]),Object.assign(w.meta,u,{joint:1}),n};const De=e=>[re(e),O((t,r,{a})=>a,1)],et=(e,t,r,a,n)=>{let i=U(e),o=i?F(e):se(),u=se(i);return i||W({parent:e,node:[T({from:ee,target:o}),T({from:"value",store:1,target:u})],family:{owners:[e,t,r],links:t},meta:{op:n},regional:1}),P("sampleSource",u,o,a),[o,u]};var tt=new Map,St=j();function Ht(e){return t=>function({adapter:r,store:a,source:n=a,target:i=a,clock:o=n,done:u,fail:g=St,finally:d,pickup:h,key:c,keyPrefix:p=""}){if(!r)throw Error("Adapter is not defined");if(!n)throw Error("Store or source is not defined");if(!i)throw Error("Target is not defined");if(!c&&n.shortName===n.id)throw Error("Key or name is not defined");if(n===i&&!Rt.store(n))throw Error("Source must be different from target");var l=c||n.shortName,s=function(v,w){var y=tt.get(v);y===void 0&&(y=new Map,tt.set(v,y));var b=y.get(w);return b!==void 0||(b=de(null,{serialize:"ignore"}),y.set(w,b)),b}(r.keyArea||r,p+l),f=W(),m=()=>mt(f),$=v=>({status:w,params:y,result:b,error:S})=>w==="done"?{status:w,key:l,keyPrefix:p,operation:v,value:v==="get"?b:y}:{status:w,key:l,keyPrefix:p,operation:v,value:y,error:S};return $t(f,()=>{var v=xe(),w=xe(),y=j(),b=y.filterMap(({status:q,key:J,keyPrefix:qe,operation:Ce,value:Ee})=>q==="done"?{key:J,keyPrefix:qe,operation:Ce,value:Ee}:void 0),S=y.filterMap(({status:q,key:J,keyPrefix:qe,operation:Ce,error:Ee,value:xt})=>q==="fail"?{key:J,keyPrefix:qe,operation:Ce,error:Ee,value:xt}:void 0),k=r(p+l,v);v.use(k.get),w.use(k.set);var M=j();Qe({source:n,clock:o,target:M}),At({source:Qe(s,M,(q,J)=>[J,q]),filter:([q,J])=>q!==J,target:w.prepend(([q])=>q)}),V({from:[v.doneData,w],to:s}),V({from:[v.doneData,s],to:i}),V({from:[v.finally.map($("get")),w.finally.map($("set"))],to:y}),V({from:S,to:g}),u&&V({from:b,to:u}),d&&V({from:y,to:d}),h?V({from:h,to:v.prepend(()=>{})}):v()}),m.unsubscribe=m}({...e,...t})}St.watch(e=>console.error(e.error));var Qt=Ht();export{At as $,Nt as k,Rt as n,de as p,j as u,Jt as v,Qe as x,Qt as y};
